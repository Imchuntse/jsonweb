{"version":3,"sources":["../../src/evaluators/templateProcessor.ts"],"names":["unitRegex","RegExp","units","join","hasMeta","value","__linaria","processedPaths","WeakSet","getTemplateProcessor","types","t","options","process","styled","path","state","valueCache","has","add","quasi","node","interpolations","isReferenced","slug","displayName","className","parent","findParent","p","isObjectProperty","isJSXOpeningElement","isVariableDeclarator","parentNode","isIdentifier","id","referencePaths","scope","getBinding","name","length","cssText","expressions","get","quasis","forEach","el","i","self","appended","cooked","matches","match","last","unit","endsWith","replace","ex","isExpression","buildCodeFrameError","code","end","loc","result","evaluate","beforeLength","next","start","line","column","confident","replacements","push","original","isFunctionExpression","isArrowFunctionExpression","source","getSource","selector","component","extends","props","objectProperty","identifier","stringLiteral","it","key","objectExpression","Object","keys","map","items","arrayExpression","replaceWith","callExpression","file","metadata","localName","addComment","includes","rules"],"mappings":"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","sourcesContent":["/**\n * This file handles transforming template literals to class names or styled components and generates CSS content.\n * It uses CSS code from template literals and evaluated values of lazy dependencies stored in ValueCache.\n */\n\nimport type { Expression } from '@babel/types';\nimport generator from '@babel/generator';\n\nimport type { StyledMeta } from '@linaria/core';\nimport { debug } from '@linaria/logger';\nimport { units } from '../units';\nimport type {\n  State,\n  StrictOptions,\n  TemplateExpression,\n  ValueCache,\n} from '../types';\n\nimport isSerializable from '../utils/isSerializable';\nimport throwIfInvalid from '../utils/throwIfInvalid';\nimport stripLines from '../utils/stripLines';\nimport toCSS from '../utils/toCSS';\nimport getLinariaComment from '../utils/getLinariaComment';\nimport { Core } from '../babel';\n\n// Match any valid CSS units followed by a separator such as ;, newline etc.\nconst unitRegex = new RegExp(`^(${units.join('|')})(;|,|\\n| |\\\\))`);\n\ntype Interpolation = {\n  id: string;\n  node: Expression;\n  source: string;\n  unit: string;\n};\n\nfunction hasMeta(value: any): value is StyledMeta {\n  return value && typeof value === 'object' && (value as any).__linaria;\n}\n\nconst processedPaths = new WeakSet();\n\nexport default function getTemplateProcessor(\n  { types: t }: Core,\n  options: StrictOptions\n) {\n  return function process(\n    { styled, path }: TemplateExpression,\n    state: State,\n    valueCache: ValueCache\n  ) {\n    if (processedPaths.has(path)) {\n      // Do not process an expression\n      // if it is referenced in one template more than once\n      return;\n    }\n\n    processedPaths.add(path);\n\n    const { quasi } = path.node;\n\n    const interpolations: Interpolation[] = [];\n\n    // Check if the variable is referenced anywhere for basic DCE\n    // Only works when it's assigned to a variable\n    let isReferenced = true;\n\n    const [, slug, displayName, className] = getLinariaComment(path);\n\n    const parent = path.findParent(\n      (p) =>\n        t.isObjectProperty(p) ||\n        t.isJSXOpeningElement(p) ||\n        t.isVariableDeclarator(p)\n    );\n\n    if (parent) {\n      const parentNode = parent.node;\n      if (t.isVariableDeclarator(parentNode) && t.isIdentifier(parentNode.id)) {\n        const { referencePaths } = path.scope.getBinding(\n          parentNode.id.name\n        ) || { referencePaths: [] };\n\n        isReferenced = referencePaths.length !== 0;\n      }\n    }\n\n    // Serialize the tagged template literal to a string\n    let cssText = '';\n\n    const expressions = path.get('quasi').get('expressions');\n\n    quasi.quasis.forEach((el, i, self) => {\n      let appended = false;\n\n      if (i !== 0 && el.value.cooked) {\n        // Check if previous expression was a CSS variable that we replaced\n        // If it has a unit after it, we need to move the unit into the interpolation\n        // e.g. `var(--size)px` should actually be `var(--size)`\n        // So we check if the current text starts with a unit, and add the unit to the previous interpolation\n        // Another approach would be `calc(var(--size) * 1px), but some browsers don't support all units\n        // https://bugzilla.mozilla.org/show_bug.cgi?id=956573\n        const matches = el.value.cooked.match(unitRegex);\n\n        if (matches) {\n          const last = interpolations[interpolations.length - 1];\n          const [, unit] = matches;\n\n          if (last && cssText.endsWith(`var(--${last.id})`)) {\n            last.unit = unit;\n            cssText += el.value.cooked.replace(unitRegex, '$2');\n            appended = true;\n          }\n        }\n      }\n\n      if (!appended) {\n        cssText += el.value.cooked;\n      }\n\n      const ex = expressions[i];\n\n      if (ex && !ex.isExpression()) {\n        throw ex.buildCodeFrameError(\n          `The expression '${generator(ex.node).code}' is not supported.`\n        );\n      }\n\n      if (ex) {\n        const { end } = ex.node.loc!;\n        const result = ex.evaluate();\n        const beforeLength = cssText.length;\n\n        // The location will be end of the current string to start of next string\n        const next = self[i + 1];\n        const loc = {\n          // +1 because the expressions location always shows 1 column before\n          start: { line: el.loc!.end.line, column: el.loc!.end.column + 1 },\n          end: next\n            ? { line: next.loc!.start.line, column: next.loc!.start.column }\n            : { line: end.line, column: end.column + 1 },\n        };\n\n        if (result.confident) {\n          throwIfInvalid(result.value, ex);\n\n          if (isSerializable(result.value)) {\n            // If it's a plain object or an array, convert it to a CSS string\n            cssText += stripLines(loc, toCSS(result.value));\n          } else {\n            cssText += stripLines(loc, result.value);\n          }\n\n          state.replacements.push({\n            original: loc,\n            length: cssText.length - beforeLength,\n          });\n        } else {\n          // Try to preval the value\n          if (\n            options.evaluate &&\n            !(t.isFunctionExpression(ex) || t.isArrowFunctionExpression(ex))\n          ) {\n            const value = valueCache.get(ex.node);\n            throwIfInvalid(value, ex);\n\n            // Skip the blank string instead of throw ing an error\n            if (value === '') {\n              return;\n            }\n\n            if (value && typeof value !== 'function') {\n              // Only insert text for non functions\n              // We don't touch functions because they'll be interpolated at runtime\n\n              if (hasMeta(value)) {\n                // If it's an React component wrapped in styled, get the class name\n                // Useful for interpolating components\n                cssText += `.${value.__linaria.className}`;\n              } else if (isSerializable(value)) {\n                cssText += stripLines(loc, toCSS(value));\n              } else {\n                // For anything else, assume it'll be stringified\n                cssText += stripLines(loc, value);\n              }\n\n              state.replacements.push({\n                original: loc,\n                length: cssText.length - beforeLength,\n              });\n\n              return;\n            }\n          }\n\n          if (styled) {\n            const id = `${slug}-${i}`;\n\n            interpolations.push({\n              id,\n              node: ex.node,\n              source: ex.getSource() || generator(ex.node).code,\n              unit: '',\n            });\n\n            cssText += `var(--${id})`;\n          } else {\n            // CSS custom properties can't be used outside components\n            throw ex.buildCodeFrameError(\n              `The CSS cannot contain JavaScript expressions when using the 'css' tag. To evaluate the expressions at build time, pass 'evaluate: true' to the babel plugin.`\n            );\n          }\n        }\n      }\n    });\n\n    let selector = `.${className}`;\n\n    if (styled) {\n      // If `styled` wraps another component and not a primitive,\n      // get its class name to create a more specific selector\n      // it'll ensure that styles are overridden properly\n      if (options.evaluate && t.isIdentifier(styled.component.node)) {\n        let value = valueCache.get(styled.component.node.name);\n        while (hasMeta(value)) {\n          selector += `.${value.__linaria.className}`;\n          value = value.__linaria.extends;\n        }\n      }\n\n      const props = [];\n\n      props.push(\n        t.objectProperty(t.identifier('name'), t.stringLiteral(displayName!))\n      );\n\n      props.push(\n        t.objectProperty(t.identifier('class'), t.stringLiteral(className!))\n      );\n\n      // If we found any interpolations, also pass them so they can be applied\n      if (interpolations.length) {\n        // De-duplicate interpolations based on the source and unit\n        // If two interpolations have the same source code and same unit,\n        // we don't need to use 2 custom properties for them, we can use a single one\n        const result: { [key: string]: Interpolation } = {};\n\n        interpolations.forEach((it) => {\n          const key = it.source + it.unit;\n\n          if (key in result) {\n            cssText = cssText.replace(\n              `var(--${it.id})`,\n              `var(--${result[key].id})`\n            );\n          } else {\n            result[key] = it;\n          }\n        });\n\n        props.push(\n          t.objectProperty(\n            t.identifier('vars'),\n            t.objectExpression(\n              Object.keys(result).map((key) => {\n                const { id, node, unit } = result[key];\n                const items = [node];\n\n                if (unit) {\n                  items.push(t.stringLiteral(unit));\n                }\n\n                return t.objectProperty(\n                  t.stringLiteral(id),\n                  t.arrayExpression(items)\n                );\n              })\n            )\n          )\n        );\n      }\n\n      path.replaceWith(\n        t.callExpression(\n          t.callExpression(\n            t.identifier(state.file.metadata.localName || 'styled'),\n            [styled.component.node]\n          ),\n          [t.objectExpression(props)]\n        )\n      );\n\n      path.addComment('leading', '#__PURE__');\n    } else {\n      path.replaceWith(t.stringLiteral(className!));\n    }\n\n    if (!isReferenced && !cssText.includes(':global')) {\n      return;\n    }\n\n    debug(\n      'evaluator:template-processor:extracted-rule',\n      `\\n${selector} {${cssText}\\n}`\n    );\n\n    state.rules[selector] = {\n      cssText,\n      className: className!,\n      displayName: displayName!,\n      start: path.parent?.loc?.start ?? null,\n    };\n  };\n}\n"],"file":"templateProcessor.js"}